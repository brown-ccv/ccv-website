# This only gets re-run when a new Meilisearch version is released with important features or security fixes
# .github/workflows/deploy-meilisearch.yaml
name: Deploy Meilisearch

on:
  workflow_dispatch:

env:
  gcp_project_id: ccv-website-next
  gcp_registry_url: us-central1-docker.pkg.dev
  gcp_artifact_registry: gcp-ccv-website
  meilisearch_bucket: ccv-website-next-meilisearch-data

jobs:
  deploy-meilisearch:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.gcp_project_id }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: "google-github-actions/setup-gcloud@v2"

      # Create Cloud Storage bucket for Meilisearch data (only needed once)
      - name: Create Storage Bucket
        run: |
          BUCKET_NAME="${{ env.meilisearch_bucket }}"
          
          echo "Checking if bucket exists: gs://${BUCKET_NAME}"
          
          # Check if bucket exists
          if gcloud storage buckets describe "gs://${BUCKET_NAME}" --project=${{ env.gcp_project_id }} 2>/dev/null; then
            echo "✅ Bucket already exists and is accessible"
          else
            EXIT_CODE=$?
          
            # If bucket doesn't exist, create it
            echo "Creating bucket: gs://${BUCKET_NAME}"
          
            if gcloud storage buckets create "gs://${BUCKET_NAME}" \
              --project=${{ env.gcp_project_id }} \
              --location=us-central1 \
              --uniform-bucket-level-access; then
              echo "✅ Bucket created successfully"
            else
              echo "❌ Failed to create bucket"
              echo "Possible reasons:"
              echo "  - Bucket name collision (name taken globally)"
              echo "  - Insufficient permissions"
              echo "  - Invalid project ID"
              exit 1
            fi
          fi

      - name: Deploy Meilisearch to Cloud Run
        run: |
          gcloud run deploy meilisearch \
            --image getmeili/meilisearch:v1.6.0 \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars MEILI_MASTER_KEY=${{ secrets.MEILISEARCH_MASTER_KEY }},MEILI_ENV=production \
            --execution-environment gen2 \
            --add-volume name=meilisearch-data,type=cloud-storage,bucket=${{ env.meilisearch_bucket }} \
            --add-volume-mount volume=meilisearch-data,mount-path=/meili_data \
            --memory 1Gi \
            --cpu 1 \
            --concurrency 10 \
            --timeout 10 \
            --min-instances 1 \
            --max-instances 1 \
            --port 7700

      - name: Get Meilisearch URL
        id: get-url
        run: |
          URL=$(gcloud run services describe meilisearch --platform managed --region us-central1 --format 'value(status.url)')
          echo "MEILISEARCH_URL=$URL" >> $GITHUB_OUTPUT
          echo "✅ Meilisearch deployed to: $URL"
