# This only gets re-run when a new Meilisearch version is released with important features or security fixes
name: Deploy Meilisearch

on:
  workflow_dispatch:

env:
  gcp_project_id: ccv-website-next
  gcp_registry_url: us-central1-docker.pkg.dev
  gcp_container_registry: gcp-ccv-website

jobs:
  deploy-meilisearch:
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.gcp_project_id }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: "google-github-actions/setup-gcloud@v2"

      # Create Cloud Storage bucket for Meilisearch data (only needed once)
      - name: Create Storage Bucket
        run: |
          gsutil mb -l us-central1 gs://ccv-meilisearch-data 2>/dev/null || echo "Bucket already exists"

      - name: Deploy Meilisearch to Cloud Run
        run: |
          gcloud run deploy meilisearch \
            --image getmeili/meilisearch:v1.6.0-alpine \
            --platform managed \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars MEILI_MASTER_KEY=${{ secrets.MEILISEARCH_MASTER_KEY }},MEILI_ENV=production \
            --execution-environment gen2 \
            --add-volume name=meilisearch-data,type=cloud-storage,bucket=ccv-meilisearch-data \
            --add-volume-mount volume=meilisearch-data,mount-path=/meili_data \
            --memory 1Gi \
            --cpu 1 \
            --concurrency 10 \
            --timeout 10 \
            --min-instances 1 \
            --max-instances 1 \
            --port 7700

      - name: Get Meilisearch URL
        id: get-url
        run: |
          URL=$(gcloud run services describe meilisearch --platform managed --region us-central1 --format 'value(status.url)')
          echo "MEILISEARCH_URL=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Meilisearch deployed to: $URL"
